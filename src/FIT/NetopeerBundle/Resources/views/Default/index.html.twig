{% extends 'FITNetopeerBundle::layout.html.twig' %}

{% block javascripts %}
	{% if (getSchemaWithAjax is defined and getSchemaWithAjax == true) %}
		{#% set idForAjaxGetSchema = 0 %#}
		<script type="text/javascript">
			$(document).ready(function() {
				var idForAjaxGetSchema = {{ idForAjaxGetSchema }};
				var targetConfigure = $("#row-" + idForAjaxGetSchema + " .configure");
				targetConfigure.find('> a').hide();
				$("<span/>", {
					'class': 'loading',
					text: "Loading..."
				}).appendTo(targetConfigure);
				$.get("{{ path("getSchema", {"key": idForAjaxGetSchema} ) }}", function(data) {
					var dataArr = $.parseJSON(data);
					if (dataArr['status'] == "success") {
						targetConfigure.find(".loading").remove();
						targetConfigure.find("> a").show();
					} else {
						targetConfigure.find(".loading").remove();
						targetConfigure.text("Could not configure device.");
					}
					if (dataArr['message']) {
						var flash = prepareFlashMessage(jsonArr['status'], jsonArr['message']);
						$(".alert-cover").append($(flash).hide());
						$(flash).animateAlert();
					}
					reloadHistoryOfConnectedDevices();
				});
			});
		</script>
	{% endif %}
	<script type="text/javascript">
		$(document).ready(function() {
			setLeftPaneHeight();
			reloadHistoryOfConnectedDevices();
			reloadProfilesOfConnectedDevices();
		});

		$(window).resize(function() {
			setLeftPaneHeight();
		});

		function prepareFlashMessage(status, message) {
			var flashMessage = $("<div/>", {
				"class": "alert " + status
			});
			flashMessage.text(message);
			flashMessage.prepend($("<span/>").addClass('close').text('X'));
			setTimeout(function() {
				flashMessage.fadeOut().remove();
			}, 3000);
			return flashMessage;
		}

		function setLeftPaneHeight() {
			$("#history-and-profiles").height($(window).height() - parseInt($("#left").css('padding-top'), 10));
		}

		function delegateAnchorActions($elem) {
			$elem.delegate(".icon", 'click', function($e) {
				$e.preventDefault();
				var $target = $($e.target);
				$.get($target.data().action, function(data) {
					var jsonArr = $.parseJSON(data);
					if (jsonArr['result'] === 0) {
						if ($target.hasClass('delete')) {
							$target.parents('a.device-item').unbind('click').remove();
							if ($elem.attr('id') == "profiles-of-connected-devices") {
								reloadProfilesOfConnectedDevices(true);
							}
						} else if ($target.hasClass('addToProfiles')) {
							reloadProfilesOfConnectedDevices(true);
						}
					}
					if (jsonArr['message']) {
						var flash = prepareFlashMessage(jsonArr['status'], jsonArr['message']);
						$(".alert-cover").append($(flash).hide());
						$(flash).animateAlert();
					}
				});
			}).delegate("a.device-item", 'click', function($e) {
				$e.preventDefault();

				var $target = $($e.target);
				if (!$target.hasClass('icon')) {
					updateConnectFormValues($(this), $(this).data().deviceId);
				}
			})
		}

		function reloadHistoryOfConnectedDevices(force) {
			$.get("{{ path("historyOfConnectedDevices") }}", function(data) {
				if (!$("#history-of-connected-devices").length || force === true) {
					$("#history-of-connected-devices").remove();
					$("#history-and-profiles").prepend(data);
					delegateAnchorActions($("#history-of-connected-devices"));
				}
			});
		}

		function reloadProfilesOfConnectedDevices(force) {
			$.get("{{ path("profilesOfConnectedDevices") }}", function(data) {
				if (!$("#profiles-of-connected-devices").length || force === true) {
					$("#profiles-of-connected-devices").remove();
					$("#history-and-profiles").append(data);
					delegateAnchorActions($("#profiles-of-connected-devices"));
				}
			});
		}

		function updateConnectFormValues($el, connectedDeviceId) {
			var url = "{{ path("connectedDeviceAttr", {"connectedDeviceId": 0}) }}";
			url = url.replace("0", connectedDeviceId);
			$.get(url, function(data) {
				if (data !== false) {
					var jsonArr = $.parseJSON(data);
					$("#form_host").val(jsonArr['host']);
					$("#form_port").val(jsonArr['port']);
					$("#form_user").val(jsonArr['userName']);

					$("#history-and-profiles").find('a').removeClass('active');
					$el.addClass('active');
				}
			});
		}
	</script>
{% endblock javascripts %}

{% block title %}Connection management{% endblock title %}

{% block singleContentClass %}
	max-width-column
{% endblock singleContentClass %}

{% block leftColumn %}
	<div id="history-and-profiles"></div>
{% endblock leftColumn %}

{% block state %}
	<form action="{{ path('_home') }}" method="post" {{ form_enctype(form) }} class="login">
		<legend>Connect to server</legend>
	    {{ form_widget(form) }}
	    <input type="submit" value="Connect" />
	</form>
{% endblock state %}

{% block config %}
	<h2>Active connection list</h2>
	{% if sessionConnections is empty %}
		<div class="alert info">
			You are not connected to any server.
		</div>
	{% else %}
		<table>
			{% for key in sessionConnections %}
				<tr id="row-{{ loop.index - 1 }}">
					<td> {{ key.time }} </td>
					<td>{{ key.host }}</td>
					<td class="configure"><a href='{{ path("handleConnection", {"command": "get", "key": loop.index - 1} ) }}'><span id="ico-conf"></span>Configure device</a></td>
					<td><a href='{{ path("handleConnection", {"command": "disconnect", "key": loop.index - 1} ) }}'>disconnect</a></td>
				</tr>
			{% endfor %}
		</table>
	{% endif %}
{% endblock config %}
